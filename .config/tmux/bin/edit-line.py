#!/usr/bin/env python3

# intro:
#
#   global `<C-x><C-e>` (readline editor / zsh zle)
#
# usage:
#
#   # add to tmux.conf (modify key / path accordingly):
#   bind -n M-e run ~/.config/tmux/bin/edit-line.py

from shlex import split as shlex_split
import subprocess
import os
import time
import tempfile


edit_buffer = tempfile.gettempdir() + '/tmux-edit-line-temp.txt'


def current_pane():
    # -J: join wrapping line
    # -N: keep trailing whitespace
    return subprocess.check_output(shlex_split('tmux capture -p -N -J'), text=True).rstrip()


def main():
    content_old = current_pane()
    subprocess.run(shlex_split('tmux send C-e C-u'))
    content_new = current_pane()

    # if tty is slow (e.g. ssh into remote server), then wait until content is refreshed.
    retry_left = 20 # 20 * 0.1 = 2s.

    if subprocess.check_output(shlex_split('tmux display -p "#{pane_current_command}"'), text=True).strip() != 'ssh':
        # ...only wait that long for ssh.
        retry_left = 1

    while retry_left > 0:
        retry_left -= 1
        i = current_pane()
        if i != content_old:
            content_new = i
            break
        time.sleep(0.1)

    if content_old.splitlines()[-1] == content_new.splitlines()[-1]:
        # if it's tmux, strip statusline.
        content_old = content_old[:content_old.rfind('\n')].rstrip()
        content_new = content_new[:content_new.rfind('\n')].rstrip()

    # use last line as content fallback
    content_diff = content_new.splitlines()[-1]

    # use diff generated by <C-u> if possible
    if content_old.startswith(content_new):
        content_diff = content_old[len(content_new):]
        content_diff = content_diff.lstrip()
        content_diff = content_diff.replace('\n', '')

    with open(edit_buffer, 'w') as f:
        f.write(content_diff)
    subprocess.run(shlex_split('tmux popup -E vim -c "setf bash"') + [edit_buffer], text=True)
    with open(edit_buffer) as f:
        line = f.read().rstrip()
    os.remove(edit_buffer)

    if line:
        subprocess.run(['tmux', 'send', '-l', '--', line])


main()
